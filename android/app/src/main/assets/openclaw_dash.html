<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenClaw Companion</title>
  <style>
    body { margin:0; font-family: system-ui, sans-serif; background:#000; color:#e6e6e6; }
    header { padding:14px 16px; border-bottom:1px solid #222; display:flex; align-items:center; gap:12px; }
    .pill { padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid #333; }
    .ok { border-color:#2bff88; color:#2bff88; }
    .bad { border-color:#ff2b5c; color:#ff2b5c; }
    main { padding:16px; display:grid; gap:12px; }
    .card { border:1px solid #222; border-radius:14px; padding:14px; background:#0a0a0a; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .field { display:flex; flex-direction:column; gap:6px; }
    input[type="text"] { background:#080808; color:#fff; border:1px solid #333; border-radius:10px; padding:10px 12px; width:100%; max-width:520px; }
    button { background:#111; color:#fff; border:1px solid #333; border-radius:12px; padding:12px 14px; cursor:pointer; }
    button:disabled { opacity:.45; cursor:not-allowed; }
    #errorBanner { display:none; border:1px solid #ff2b5c; color:#ff7a96; background:#19040a; padding:10px 12px; border-radius:12px; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; }
    pre { white-space: pre-wrap; word-break: break-word; background:#060606; border:1px solid #222; padding:10px; border-radius:12px; }
  </style>
</head>
<body>
  <header>
    <strong>OpenClaw Companion</strong>
    <span id="pillConnected" class="pill bad">DISCONNECTED</span>
    <span id="pillRegistered" class="pill bad">UNREGISTERED</span>
    <span class="pill" id="pillHeartbeat">HB: —</span>
  </header>

  <main>
    <div id="errorBanner"></div>

    <div class="card">
      <h3>Gateway</h3>
      <div class="field">
        <label for="controllerUrlInput"><small>Controller URL</small></label>
        <input id="controllerUrlInput" type="text" inputmode="url" placeholder="ws://controller:8787/ws" />
      </div>
      <div class="row">
        <button id="btnConnect" onclick="connectGateway()">Connect</button>
        <button id="btnDisconnect" onclick="disconnectGateway()">Disconnect</button>
        <button id="btnStatus" onclick="requestStatus()">Refresh Status</button>
      </div>
      <p><small>Active URL: <code id="controllerUrl">—</code></small></p>
    </div>

    <div class="card">
      <h3>Capabilities</h3>
      <div class="row">
        <button id="btnCamsnap" onclick="triggerCamsnap()">Camsnap</button>
      </div>
      <p><small>Last result:</small></p>
      <pre id="lastResult">{}</pre>
    </div>

    <div class="card">
      <h3>Debug</h3>
      <div class="row">
        <button id="btnCopyLogs" onclick="copyLastLogs()">Copy last logs</button>
        <button id="btnClearError" onclick="clearError()">Clear error</button>
      </div>
      <pre id="lastLogs">No logs yet.</pre>
    </div>
  </main>

<script>
  // ========= REQUIRED PUBLIC JS API (names exact) =========
  function connectGateway() {
    const controllerUrl = readControllerUrl();
    if (!controllerUrl) {
      showError(formatError('MISSING_CONTROLLER_URL'));
      return;
    }
    persistControllerUrl(controllerUrl);
    return callBridge('connectGateway', { controllerUrl });
  }
  function disconnectGateway() {
    return callBridge('disconnectGateway', {});
  }
  function triggerCamsnap() {
    // Optional args: quality(0-100), maxBytes
    return callBridge('triggerCamsnap', { quality: 85, maxBytes: 600000 });
  }
  function requestStatus() {
    return callBridge('requestStatus', {});
  }

  // ========= Bridge plumbing =========
  function callBridge(method, args) {
    try {
      if (!window.OpenClawBridge || typeof window.OpenClawBridge[method] !== 'function') {
        showError(`Missing backend handler: OpenClawBridge.${method}()`);
        setButtonsEnabled(false);
        return;
      }
      const raw = window.OpenClawBridge[method](JSON.stringify(args || {}));
      const resp = safeJson(raw);
      if (!resp || resp.ok !== true) {
        showError(formatError(resp?.code, resp?.message, resp?.data));
      } else {
        clearUiError();
      }
      // Update UI state if included
      if (resp && resp.data && resp.data.state) applyState(resp.data.state);
      if (resp && resp.data && resp.data.result) document.getElementById('lastResult').textContent = JSON.stringify(resp.data.result, null, 2);
      if (resp && resp.data && resp.data.lastLogs) document.getElementById('lastLogs').textContent = resp.data.lastLogs;
      return resp;
    } catch (e) {
      showError(`Bridge error: ${String(e)}`);
    }
  }

  // Called by Android when state changes (optional)
  function onStateUpdate(stateJson) {
    const state = safeJson(stateJson);
    if (state) applyState(state);
  }

  function applyState(state) {
    const connected = !!state.connected;
    const registered = !!state.registered;
    setPill('pillConnected', connected, connected ? 'CONNECTED' : 'DISCONNECTED');
    setPill('pillRegistered', registered, registered ? 'REGISTERED' : 'UNREGISTERED');
    document.getElementById('pillHeartbeat').textContent = `HB: ${state.lastHeartbeat || '—'}`;
    document.getElementById('controllerUrl').textContent = state.controllerUrl || '—';
    updateControllerInput(state.controllerUrl);
    if (state.lastCapabilityResult) {
      document.getElementById('lastResult').textContent = JSON.stringify(state.lastCapabilityResult, null, 2);
    } else {
      document.getElementById('lastResult').textContent = '';
    }
    stateError = state.lastError ? formatError(state.lastError, null, null) : null;
    renderError();
    // Buttons are truthful: disable camsnap unless connected (and optionally registered)
    document.getElementById('btnCamsnap').disabled = !connected;
    document.getElementById('btnDisconnect').disabled = !connected;
    document.getElementById('btnConnect').disabled = connected;
  }

  function setPill(id, ok, text) {
    const el = document.getElementById(id);
    el.textContent = text;
    el.classList.remove('ok','bad');
    el.classList.add(ok ? 'ok' : 'bad');
  }

  function setButtonsEnabled(enabled) {
    ['btnConnect','btnDisconnect','btnStatus','btnCamsnap','btnCopyLogs','btnClearError'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.disabled = !enabled;
    });
  }

  let lastUiError = null;
  let stateError = null;
  function showError(msg) {
    lastUiError = msg;
    renderError();
  }
  function renderError() {
    const b = document.getElementById('errorBanner');
    const msg = stateError || lastUiError;
    if (msg) {
      b.style.display = 'block';
      b.textContent = msg;
    } else {
      b.style.display = 'none';
      b.textContent = '';
    }
  }
  function clearError(){
    clearUiError();
  }
  function clearUiError() {
    lastUiError = null;
    renderError();
  }

  function copyLastLogs() {
    const txt = document.getElementById('lastLogs').textContent || '';
    navigator.clipboard?.writeText(txt);
  }

  function safeJson(x){ try { return JSON.parse(x); } catch(_) { return null; } }

  function formatError(code, message, data) {
    if (!code && message) return message;
    switch (code) {
      case 'MISSING_CONTROLLER_URL':
        return 'Missing controller URL. Enter a ws:// URL before connecting.';
      case 'CONTROLLER_UNREACHABLE':
        return 'Controller unreachable. Check the URL, network, and gateway status.';
      case 'REGISTER_ACK_FAILED':
        return 'Controller rejected registration. Check controller logs for details.';
      case 'PERMISSION_DENIED':
        return `Permission denied: ${(data?.missingPermissions || []).join(', ') || 'camera'}`;
      case 'PERMISSION_MISSING':
        return `Permission missing: ${(data?.missingPermissions || []).join(', ') || 'camera'}`;
      case 'CAMERA_UNAVAILABLE':
        return 'Camera unavailable. Ensure the camera is not in use and the device has one.';
      case 'CAMERA_BIND_FAILED':
        return 'Camera bind failed. Close other camera apps and retry.';
      case 'IMAGE_TOO_LARGE':
        return 'Captured image exceeds maxBytes. Reduce quality or maxBytes.';
      case 'CAPTURE_FAILED':
        return 'Capture failed. Check camera permissions and availability.';
      case 'CAPTURE_READ_FAILED':
        return 'Capture saved but could not be read.';
      default:
        return message || code || 'Unknown error';
    }
  }

  function readControllerUrl() {
    const input = document.getElementById('controllerUrlInput');
    const value = input?.value?.trim();
    if (value) return value;
    return localStorage.getItem('openclaw.controllerUrl') || '';
  }

  function updateControllerInput(url) {
    if (!url) return;
    const input = document.getElementById('controllerUrlInput');
    if (input && input.value.trim() !== url) {
      input.value = url;
      persistControllerUrl(url);
    }
  }

  function persistControllerUrl(url) {
    localStorage.setItem('openclaw.controllerUrl', url);
  }

  // Boot: request initial state
  const storedUrl = localStorage.getItem('openclaw.controllerUrl');
  if (storedUrl) {
    document.getElementById('controllerUrlInput').value = storedUrl;
  }
  requestStatus();
</script>
</body>
</html>
